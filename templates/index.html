<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discord Bot Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <nav class="navbar navbar-expand-lg bg-body-tertiary shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <i class="bi bi-robot me-2 fs-4 text-primary"></i>
                <span class="fw-bold">Discord Bot x SHARE IT HUB</span>
            </a>
            <div class="d-flex">
                <button class="btn btn-outline-light" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasLogs" aria-controls="offcanvasLogs">
                    <i class="bi bi-terminal"></i> Log
                </button>
            </div>
        </div>
    </nav>

    <div id="save-notification" class="save-notification"></div>

    <div class="container-fluid py-4">
        <div class="row mb-4">
            <div class="col-12 col-lg-6 mb-4 mb-lg-0">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-discord me-2 text-info fs-5"></i>
                            <h5 class="mb-0">Discord Tokens</h5>
                        </div>
                        <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#addTokenModal">
                            <i class="bi bi-plus-lg me-1"></i> Add Token
                        </button>
                    </div>
                    <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                        <div id="discord-tokens-list">
                            {% if config.discord_tokens %}
                                {% for token in config.discord_tokens %}
                                <div class="token-item mb-2 p-3 border border-secondary rounded bg-dark" data-index="{{ loop.index0 }}">
                                    <div class="d-flex align-items-center gap-2">
                                        <div class="flex-grow-1">
                                            <div class="d-flex align-items-center mb-2">
                                                <span class="badge bg-primary me-2">Token #{{ loop.index0 }}</span>
                                                {% set bot = bot_accounts | selectattr('index', 'equalto', loop.index0) | first %}
                                                {% if bot %}
                                                <span class="badge bg-success">
                                                    <i class="bi bi-check-circle me-1"></i>{{ bot.username }}#{{ bot.discriminator }}
                                                </span>
                                                {% else %}
                                                <span class="badge bg-danger">
                                                    <i class="bi bi-x-circle me-1"></i>Invalid
                                                </span>
                                                {% endif %}
                                            </div>
                                            <div class="input-group input-group-sm">
                                                <input type="password" class="form-control token-input font-monospace" value="{{ token }}" readonly>
                                                <button class="btn btn-outline-secondary toggle-token-visibility d-flex align-items-center justify-content-center" type="button" title="Show/Hide" style="width: 40px;">
                                                    <i class="bi bi-eye"></i>
                                                </button>
                                                <button class="btn btn-outline-info copy-token-btn d-flex align-items-center justify-content-center" type="button" title="Copy" style="width: 40px;">
                                                    <i class="bi bi-clipboard"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <button class="btn btn-outline-danger delete-token-btn d-flex align-items-center justify-content-center" type="button" title="Delete Token" style="width: 40px; height: 40px;">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                            <div class="text-center text-muted p-4">
                                <i class="bi bi-inbox fs-1"></i>
                                <p class="mt-2">No tokens added yet.<br>Click "Add Token" to get started.</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-12 col-lg-6 mb-4 mb-lg-0">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-google me-2 text-danger fs-5"></i>
                            <h5 class="mb-0">Google API Keys</h5>
                        </div>
                        <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#addApiKeyModal">
                            <i class="bi bi-plus-lg me-1"></i> Add Key
                        </button>
                    </div>
                    <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                        <div id="google-api-keys-list">
                            {% if config.google_api_keys %}
                                {% for key in config.google_api_keys %}
                                <div class="api-key-item mb-2 p-3 border border-secondary rounded bg-dark" data-index="{{ loop.index0 }}">
                                    <div class="d-flex align-items-center gap-2">
                                        <div class="flex-grow-1">
                                            <div class="mb-2">
                                                <span class="badge bg-danger">API Key #{{ loop.index0 }}</span>
                                            </div>
                                            <div class="input-group input-group-sm">
                                                <input type="password" class="form-control api-key-input font-monospace" value="{{ key }}" readonly>
                                                <button class="btn btn-outline-secondary toggle-key-visibility d-flex align-items-center justify-content-center" type="button" title="Show/Hide" style="width: 40px;">
                                                    <i class="bi bi-eye"></i>
                                                </button>
                                                <button class="btn btn-outline-info copy-key-btn d-flex align-items-center justify-content-center" type="button" title="Copy" style="width: 40px;">
                                                    <i class="bi bi-clipboard"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <button class="btn btn-outline-danger delete-key-btn d-flex align-items-center justify-content-center" type="button" title="Delete Key" style="width: 40px; height: 40px;">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                            <div class="text-center text-muted p-4">
                                <i class="bi bi-inbox fs-1"></i>
                                <p class="mt-2">No API keys added yet.<br>Click "Add Key" to get started.</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-12 col-lg-6 mb-4 mb-lg-0">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-box-arrow-up-right me-2 text-warning fs-5"></i>
                            <h5 class="mb-0">AgentRouter API Keys</h5>
                        </div>
                        <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#addAgentRouterKeyModal">
                            <i class="bi bi-plus-lg me-1"></i> Add Key
                        </button>
                    </div>
                    <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                        <div id="agentrouter-api-keys-list">
                            {% if config.agentrouter_api_keys %}
                                {% for key in config.agentrouter_api_keys %}
                                <div class="agentrouter-key-item mb-2 p-3 border border-secondary rounded bg-dark" data-index="{{ loop.index0 }}">
                                    <div class="d-flex align-items-center gap-2">
                                        <div class="flex-grow-1">
                                            <div class="mb-2">
                                                <span class="badge bg-warning">AgentRouter Key #{{ loop.index0 }}</span>
                                            </div>
                                            <div class="input-group input-group-sm">
                                                <input type="password" class="form-control agentrouter-key-input font-monospace" value="{{ key }}" readonly>
                                                <button class="btn btn-outline-secondary toggle-agentrouter-visibility d-flex align-items-center justify-content-center" type="button" title="Show/Hide" style="width: 40px;">
                                                    <i class="bi bi-eye"></i>
                                                </button>
                                                <button class="btn btn-outline-info copy-agentrouter-btn d-flex align-items-center justify-content-center" type="button" title="Copy" style="width: 40px;">
                                                    <i class="bi bi-clipboard"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <button class="btn btn-outline-danger delete-agentrouter-btn d-flex align-items-center justify-content-center" type="button" title="Delete Key" style="width: 40px; height: 40px;">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                            <div class="text-center text-muted p-4">
                                <i class="bi bi-inbox fs-1"></i>
                                <p class="mt-2">No AgentRouter keys added yet.<br>Click "Add Key" to get started.</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-header bg-dark text-white d-flex align-items-center">
                <i class="bi bi-plus-circle-fill me-2 text-success"></i><h5 class="mb-0 d-inline">Buat Tugas Baru</h5>
            </div>
            <div class="card-body row g-3 align-items-center">
                <div class="col-lg-5"><input type="text" id="new-task-channel-id" class="form-control form-control-lg" placeholder="Masukkan Target Channel ID..."></div>
                <div class="col-lg-5">
                    <select id="new-task-account" class="form-select form-select-lg">
                        <option selected disabled>Pilih Akun Bot...</option>
                        {% for account in bot_accounts %}<option value="{{ account.index }}">{{ account.username }}#{{ account.discriminator }}</option>{% endfor %}
                    </select>
                </div>
                <div class="col-lg-2 d-grid"><button id="add-task-btn" class="btn btn-success btn-lg"><i class="bi bi-plus"></i> Buat Tugas</button></div>
            </div>
        </div>
        
        <h3 class="mb-3 text-white"><i class="bi bi-list-task me-2"></i> Daftar Tugas Aktif</h3>
        <div id="task-list" class="row">
            {% for task in config.tasks %}
            <div class="col-12 col-md-6 col-lg-4 col-xl-3 mb-4 task-card" data-task-id="{{ task.id }}">
                <input type="hidden" class="channel-id-input" value="{{ task.channel_id }}">
                <div class="card shadow-sm h-100">
                    <div class="card-header d-flex justify-content-between align-items-center bg-dark text-white">
                        <div>
                            <h6 class="mb-0 text-truncate"><i class="bi bi-hash me-1"></i> {{ task.channel_name | default("...") }}</h6>
                            <small class="text-muted d-block text-truncate">{{ task.server_name | default("...") }}</small>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            {% if not task.use_google_ai %}
                            <span class="badge bg-info">pesan.txt mode</span>
                            {% endif %}
                            <span class="status-badge badge me-2 bg-{{ 'success' if task.status == 'Running' else 'danger' }}">{{ task.status }}</span>
                            <button class="btn btn-sm btn-outline-danger remove-task-btn" title="Hapus Tugas"><i class="bi bi-x-lg"></i></button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label form-label-sm d-flex align-items-center"><i class="bi bi-person-fill-gear me-1"></i> Akun Bertugas</label>
                            <select class="form-select form-select-sm assigned-token">
                                {% for account in bot_accounts %}<option value="{{ account.index }}" {% if task.assigned_token_index == account.index %}selected{% endif %}>{{ account.username }}#{{ account.discriminator }}</option>{% endfor %}
                            </select>
                        </div>
                        <div class="mb-2">
                            <label class="form-label form-label-sm d-flex align-items-center"><i class="bi bi-sliders me-1"></i> Mode</label>
                            <select class="form-select form-select-sm mode-select">
                                {% set current_mode = task.mode if task.mode is defined else ('gemini' if task.use_google_ai else 'pesan') %}
                                <option value="gemini" {% if current_mode == 'gemini' %}selected{% endif %}>Gemini</option>
                                <option value="agentrouter" {% if current_mode == 'agentrouter' %}selected{% endif %}>AgentRouter (GPT-5)</option>
                                <option value="pesan" {% if current_mode == 'pesan' %}selected{% endif %}>pesan.txt</option>
                            </select>
                        </div>
                        <div class="ai-settings mt-3 {% if current_mode != 'gemini' and current_mode != 'agentrouter' %}d-none{% endif %}">
                            <label class="form-label form-label-sm d-flex align-items-center"><i class="bi bi-stopwatch me-1"></i> Delay Baca (detik)</label>
                            <input type="number" class="form-control form-control-sm read-delay mb-2" value="{{ task.read_delay }}">
                        </div>
                        <div class="agentrouter-settings mt-3 {% if current_mode != 'agentrouter' %}d-none{% endif %}">
                            <label class="form-label form-label-sm d-flex align-items-center"><i class="bi bi-robot me-1"></i> AgentRouter Model</label>
                            <select class="form-select form-select-sm agentrouter-model">
                                <option value="gpt-5" {% if task.agentrouter_model == 'gpt-5' %}selected{% endif %}>GPT-5 (Default)</option>
                                <option value="gpt-4" {% if task.agentrouter_model == 'gpt-4' %}selected{% endif %}>GPT-4</option>
                                <option value="gpt-4-turbo" {% if task.agentrouter_model == 'gpt-4-turbo' %}selected{% endif %}>GPT-4 Turbo</option>
                                <option value="gpt-3.5-turbo" {% if task.agentrouter_model == 'gpt-3.5-turbo' %}selected{% endif %}>GPT-3.5 Turbo</option>
                            </select>
                        </div>
                        {% if (task.mode is defined and task.mode == 'pesan') or (task.mode is not defined and not task.use_google_ai) %}
                        <div class="alert alert-info py-2 px-3 mb-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="bi bi-file-text me-1"></i>
                                    pesan.txt: {{ pesan_info.count }} baris, cache {{ 'aktif' if pesan_info.last_refresh else 'kosong' }}
                                </div>
                                <button class="btn btn-sm btn-outline-light refresh-pesan-btn" title="Refresh pesan.txt"><i class="bi bi-arrow-clockwise"></i></button>
                            </div>
                        </div>
                        {% endif %}
                        <div class="mb-2">
                            <label class="form-label form-label-sm d-flex align-items-center"><i class="bi bi-hourglass-split me-1"></i> Interval Kirim (detik)</label>
                            <input type="number" class="form-control form-control-sm delay-interval" value="{{ task.delay_interval }}">
                        </div>
                        <div class="mb-2">
                            <label class="form-label form-label-sm d-flex align-items-center"><i class="bi bi-translate me-1"></i> Bahasa</label>
                            <select class="form-select form-select-sm prompt-language">
                                <option value="id" {% if task.prompt_language == 'id' %}selected{% endif %}>Indonesia</option>
                                <option value="en" {% if task.prompt_language == 'en' %}selected{% endif %}>English</option>
                            </select>
                        </div>
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input use-reply" type="checkbox" role="switch" {% if task.use_reply %}checked{% endif %}>
                            <label class="form-check-label d-flex align-items-center"><i class="bi bi-reply-fill me-1"></i> Kirim Reply</label>
                        </div>
                        <div class="row g-2">
                            <div class="col-7">
                                <label class="form-label form-label-sm d-flex align-items-center"><i class="bi bi-clock-history me-1"></i> Hapus Balasan (detik)</label>
                                <input type="number" class="form-control form-control-sm delete-bot-reply" placeholder="Kosongkan" value="{{ task.delete_bot_reply if task.delete_bot_reply is not none }}">
                            </div>
                            <div class="col-5 d-flex align-items-end">
                                <div class="form-check form-check-sm">
                                    <input class="form-check-input delete-immediately" type="checkbox" {% if task.delete_immediately %}checked{% endif %}>
                                    <label class="form-check-label form-label-sm">Langsung?</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer bg-dark d-flex justify-content-end gap-2">
                        <button class="btn btn-success btn-sm start-bot-btn"><i class="bi bi-play-fill me-1"></i> Start</button>
                        <button class="btn btn-warning btn-sm stop-bot-btn"><i class="bi bi-stop-fill me-1"></i> Stop</button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <div class="offcanvas offcanvas-end text-bg-dark" tabindex="-1" id="offcanvasLogs" aria-labelledby="offcanvasLogsLabel" style="width: 500px;">
        <div class="offcanvas-header bg-dark border-bottom border-secondary">
            <h5 class="offcanvas-title" id="offcanvasLogsLabel">
                <i class="bi bi-terminal me-2"></i> Live Log
                <span id="log-status" class="badge bg-success ms-2" title="Connection status">●</span>
            </h5>
            <div class="d-flex gap-2 align-items-center">
                <button type="button" class="btn btn-sm btn-outline-warning" id="clear-log-btn" title="Clear logs">
                    <i class="bi bi-trash"></i>
                </button>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
            </div>
        </div>
        <div class="offcanvas-body p-0">
            <pre id="log-output" class="text-white m-0 p-3" style="height: 100%; overflow-y: auto; font-size: 0.85rem; line-height: 1.4;"></pre>
        </div>
    </div>

    <footer class="footer mt-5 pt-4 pb-3 text-center border-top border-secondary">
        <div class="container">
            <span class="text-muted mb-3 d-block">Official Links:</span>
            <div class="d-flex justify-content-center align-items-center flex-wrap gap-3">
                <a href="https://github.com/shareithub" target="_blank" class="btn btn-outline-light">
                    <i class="bi bi-github me-1"></i> Github
                </a>
                <a href="https://t.me/SHAREITHUB_COM" target="_blank" class="btn btn-outline-info">
                    <i class="bi bi-telegram me-1"></i> Telegram Channel
                </a>
                <a href="https://www.youtube.com/@shareithub_com" target="_blank" class="btn btn-outline-danger">
                    <i class="bi bi-youtube me-1"></i> Youtube Channel
                </a>
                <a href="https://t.me/LapakSwap_bot" target="_blank" class="btn btn-outline-primary">
                    <i class="bi bi-robot me-1"></i> Bot LAPAK SWAP
                </a>
                <a href="https://t.me/lapak_swap" target="_blank" class="btn btn-outline-secondary">
                    <i class="bi bi-shop me-1"></i> Channel LAPAK SWAP
                </a>
            </div>
        </div>
    </footer>

    <!-- Add Discord Token Modal -->
    <div class="modal fade" id="addTokenModal" tabindex="-1" aria-labelledby="addTokenModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title" id="addTokenModalLabel">
                        <i class="bi bi-discord me-2 text-info"></i>Add Discord Token
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <small>Open Discord in browser → Press F12 → Console → Paste the token extraction code from SETUP.md</small>
                    </div>
                    <div class="mb-3">
                        <label for="newTokenInput" class="form-label">Discord Token</label>
                        <textarea class="form-control font-monospace" id="newTokenInput" rows="3" placeholder="Paste your Discord token here..."></textarea>
                        <small class="form-text text-muted">Token format: MTk4NjIyNDgzNDcxOTI1MjQ4.Cl2FMQ.ZnCjm1XVW7vRze4b7Cq4se7kKWs</small>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="validateTokenCheck" checked>
                        <label class="form-check-label" for="validateTokenCheck">
                            Validate token before adding
                        </label>
                    </div>
                    <div id="tokenValidationResult"></div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" id="saveTokenBtn">
                        <i class="bi bi-plus-lg me-1"></i>Add Token
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Google API Key Modal -->
    <div class="modal fade" id="addApiKeyModal" tabindex="-1" aria-labelledby="addApiKeyModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title" id="addApiKeyModalLabel">
                        <i class="bi bi-google me-2 text-danger"></i>Add Google API Key
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <small>Get your API key from: <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-white">Google AI Studio</a></small>
                    </div>
                    <div class="mb-3">
                        <label for="newApiKeyInput" class="form-label">Google Gemini API Key</label>
                        <textarea class="form-control font-monospace" id="newApiKeyInput" rows="2" placeholder="Paste your Google API key here..."></textarea>
                        <small class="form-text text-muted">API key format: AIzaSyC...</small>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" id="saveApiKeyBtn">
                        <i class="bi bi-plus-lg me-1"></i>Add API Key
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add AgentRouter API Key Modal -->
    <div class="modal fade" id="addAgentRouterKeyModal" tabindex="-1" aria-labelledby="addAgentRouterKeyModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title" id="addAgentRouterKeyModalLabel">
                        <i class="bi bi-box-arrow-up-right me-2 text-warning"></i>Add AgentRouter API Key
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <small>Get your API key from: <a href="https://agentrouter.org" target="_blank" class="text-white">AgentRouter</a></small>
                    </div>
                    <div class="mb-3">
                        <label for="newAgentRouterKeyInput" class="form-label">AgentRouter API Key</label>
                        <textarea class="form-control font-monospace" id="newAgentRouterKeyInput" rows="2" placeholder="Paste your AgentRouter API key here..."></textarea>
                        <small class="form-text text-muted">Enter your AGENT_ROUTER_TOKEN</small>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" id="saveAgentRouterKeyBtn">
                        <i class="bi bi-plus-lg me-1"></i>Add API Key
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/script.js') }}"></script>

</body>
</html>